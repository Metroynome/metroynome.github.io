<html>
    <head>
        <title>Save Editor</title>
    </head>
    <body>
        <form name="uploadForm">
            <div>
            <input id="InputFile" type="file" accept=".bin" />
        </div>
        </form>
        <div>
            <label for="Name">Name: </label>
            <output id="Name">----</output>
        </div>
        <div>
            <label for="Size">Total size:</label>
            <output id="Size">----</output>
        </div>
        <div width="100%">
            <textarea id="Bytes" style="margin: 0px; width: 100%; max-width: 100%; height: 215px;"></textarea>
        </div>
        <div><input id="Save" type="submit" value="Save it!" /></div>

        <script type="text/javascript">
            function HandleFile(e){
                const selected = InputFile.files[0];
                if (selected) {
                    addListeners(reader);
                    FileInfo(e);
                    FileBytes.value = reader.readAsArrayBuffer(selected);
                };
            };
            function addListeners(reader){
                reader.addEventListener("loadstart", handleEvent);
                reader.addEventListener("load", handleEvent);
                reader.addEventListener("loadend", handleEvent);
                reader.addEventListener("progress", handleEvent);
                reader.addEventListener("error", handleEvent);
                reader.addEventListener("abort", handleEvent);
            };
            function handleEvent(event){
                function pad(num, size){
                    // num = num.toString();
                    while (num.length < size) num = "0" + num;
                    return num;
                };
                console.log(`${event.type}: ${event.loaded} bytes transferred`);
                if(event.type === "loadstart"){
                    FileBytes.value = "Reading File...Please Wait";
                }
                if(event.type === "loadend"){
                    let data = new Uint32Array(reader.result);
                    let data2 = new Uint8Array(reader.result);
                    ArrayOfBytes = data2;
                    let array = new Array();
                    let FullData = "";
                    for(var i in data){
                        let a = i * 4;
                        let Offset = pad(a.toString(16), 4).toUpperCase();
                        let Value = pad(data[i].toString(16), 8).toUpperCase();
                        FullData += `${Offset}h: ${Value}\n`;
                    };
                    FileBytes.value = FullData;
                };
            };
            function FileInfo(e){
                const TheFile = e.target.files[0];
                FileName.innerText = TheFile.name;

                // Calculate total size
                let numberOfBytes = TheFile.size;
                // Approximate to the closest prefixed unit
                const units = ["B", "KiB", "MiB"];
                const exponent = Math.min(
                    Math.floor(Math.log(numberOfBytes) / Math.log(1024)),
                    units.length - 1
                );
                const approx = numberOfBytes / 1024 ** exponent;
                const output = exponent === 0 ? `${numberOfBytes} bytes` : `${approx.toFixed(2)} ${units[exponent]} (${numberOfBytes} bytes)`;
                FileSize.textContent = output;
            };

            var textFile = null,
            makeTextFile = function(text){
                var data = new Blob([text], {type: "text/binary"});

                // If we are replacing a previously generated file we need to
                // manually revoke the object URL to avoid memory leaks.
                if (textFile !== null) {
                    window.URL.revokeObjectURL(textFile);
                }

                textFile = window.URL.createObjectURL(data);

                // returns a URL you can use as a href
                return textFile;
            };

            var create = document.getElementById("Save");
            var textbox = document.getElementById("Bytes");

            create.addEventListener('click', function () {
                var link = document.createElement("a");
                link.setAttribute("download", "patch.bin");
                link.href = makeTextFile(ArrayOfBytes);
                document.body.appendChild(link);

                // wait for the link to be added to the document
                window.requestAnimationFrame(function(){
                    var event = new MouseEvent("click");
                    link.dispatchEvent(event);
                    document.body.removeChild(link);
                });

            }, false);

            const InputFile = document.getElementById("InputFile");
            const FileName = document.getElementById("Name");
            const FileSize = document.getElementById("Size");
            const FileBytes = document.getElementById("Bytes");
            let ArrayOfBytes = "";
            const reader = new FileReader();

            InputFile.addEventListener("change", HandleFile);
        </script>
    </body>
</html>